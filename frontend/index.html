<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FABB ‚Äî Full-Auto Bug Buster</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --green: #00FF88;
      --green-dim: #00CC6A;
      --green-glow: rgba(0,255,136,0.15);
      --bg: #0d0d1a;
      --bg2: #13132a;
      --bg3: #1a1a35;
      --border: rgba(0,255,136,0.2);
      --text: #e8e8f0;
      --text-dim: #8888aa;
      --red: #FF4466;
      --yellow: #FFCC00;
      --code-bg: #0a0a1f;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: var(--bg);
      color: var(--text);
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */
    #header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 16px;
      background: var(--bg2);
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
    }
    #header .logo {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    #header .logo-icon {
      width: 28px; height: 28px;
      background: var(--green);
      border-radius: 6px;
      display: flex; align-items: center; justify-content: center;
      font-size: 14px;
      color: var(--bg);
      font-weight: bold;
    }
    #header h1 {
      font-size: 15px;
      font-weight: 700;
      color: var(--green);
      letter-spacing: 0.5px;
    }
    #header .subtitle { font-size: 10px; color: var(--text-dim); }

    .header-right { display: flex; align-items: center; gap: 8px; }

    #folder-indicator {
      display: flex; align-items: center; gap: 6px;
      background: var(--bg3);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 4px 10px;
      font-size: 11px;
      color: var(--text-dim);
      cursor: pointer;
      max-width: 200px;
    }
    #folder-indicator:hover { border-color: var(--green); color: var(--green); }
    #folder-indicator .dot {
      width: 7px; height: 7px;
      border-radius: 50%;
      background: var(--text-dim);
      flex-shrink: 0;
    }
    #folder-indicator.active .dot { background: var(--green); }
    #folder-indicator .folder-text { 
      overflow: hidden; text-overflow: ellipsis; white-space: nowrap; 
    }

    .icon-btn {
      background: var(--bg3);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text-dim);
      cursor: pointer;
      padding: 5px 8px;
      font-size: 13px;
      transition: all 0.15s;
    }
    .icon-btn:hover { border-color: var(--green); color: var(--green); }

    /* ‚îÄ‚îÄ Main layout ‚îÄ‚îÄ */
    #main { display: flex; flex: 1; overflow: hidden; }

    /* ‚îÄ‚îÄ Chat area ‚îÄ‚îÄ */
    #chat-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    #messages {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      scroll-behavior: smooth;
    }
    #messages::-webkit-scrollbar { width: 4px; }
    #messages::-webkit-scrollbar-track { background: transparent; }
    #messages::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

    /* ‚îÄ‚îÄ Message bubbles ‚îÄ‚îÄ */
    .msg { display: flex; gap: 10px; max-width: 100%; }
    .msg.user { flex-direction: row-reverse; }

    .msg-avatar {
      width: 30px; height: 30px;
      border-radius: 8px;
      display: flex; align-items: center; justify-content: center;
      font-size: 13px;
      flex-shrink: 0;
      margin-top: 2px;
    }
    .msg.user .msg-avatar { background: var(--green-dim); color: var(--bg); font-weight: bold; }
    .msg.fabb .msg-avatar { background: var(--bg3); border: 1px solid var(--border); color: var(--green); }

    .msg-content { max-width: calc(100% - 44px); display: flex; flex-direction: column; gap: 6px; }
    .msg.user .msg-content { align-items: flex-end; }

    .msg-bubble {
      padding: 10px 14px;
      border-radius: 12px;
      font-size: 13px;
      line-height: 1.6;
      word-break: break-word;
    }
    .msg.user .msg-bubble {
      background: var(--green-dim);
      color: var(--bg);
      border-radius: 12px 12px 2px 12px;
    }
    .msg.fabb .msg-bubble {
      background: var(--bg2);
      border: 1px solid var(--border);
      border-radius: 2px 12px 12px 12px;
      color: var(--text);
    }
    .msg-bubble .pipeline-line {
      color: var(--text-dim);
      font-size: 12px;
      padding: 1px 0;
    }
    .msg-bubble .pipeline-line.highlight { color: var(--green); }

    /* ‚îÄ‚îÄ Bug Report Card ‚îÄ‚îÄ */
    .bug-card {
      background: var(--bg3);
      border: 1px solid var(--border);
      border-radius: 10px;
      overflow: hidden;
      width: 100%;
    }
    .bug-card.severity-high { border-color: rgba(255,68,102,0.5); }
    .bug-card.severity-medium { border-color: rgba(255,204,0,0.4); }

    .bug-card-header {
      display: flex; align-items: center; gap: 8px;
      padding: 10px 14px;
      cursor: pointer;
      user-select: none;
    }
    .bug-card-header:hover { background: rgba(255,255,255,0.03); }

    .severity-badge {
      font-size: 10px; font-weight: 700;
      padding: 2px 7px;
      border-radius: 4px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .severity-high { background: rgba(255,68,102,0.2); color: var(--red); }
    .severity-medium { background: rgba(255,204,0,0.15); color: var(--yellow); }
    .severity-low { background: rgba(0,255,136,0.1); color: var(--green); }

    .bug-label { font-size: 13px; font-weight: 600; color: var(--text); flex: 1; }
    .bug-meta { font-size: 11px; color: var(--text-dim); }
    .chevron { font-size: 11px; color: var(--text-dim); transition: transform 0.2s; }
    .bug-card.open .chevron { transform: rotate(90deg); }

    .bug-card-body { padding: 0 14px 14px; display: none; }
    .bug-card.open .bug-card-body { display: block; }

    .bug-desc { font-size: 12px; color: var(--text-dim); margin-bottom: 10px; line-height: 1.5; }

    .llm-explanation {
      background: var(--code-bg);
      border-left: 3px solid var(--green);
      padding: 10px 12px;
      border-radius: 0 6px 6px 0;
      font-size: 12px;
      color: var(--text);
      margin-bottom: 10px;
      line-height: 1.6;
    }
    .llm-explanation .label { color: var(--green); font-weight: 600; font-size: 11px; margin-bottom: 4px; }

    .patch-block {
      background: var(--code-bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      overflow: hidden;
      margin-top: 8px;
    }
    .patch-header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 6px 12px;
      background: rgba(0,255,136,0.05);
      border-bottom: 1px solid var(--border);
    }
    .patch-header span { font-size: 11px; color: var(--green); font-weight: 600; }
    .copy-btn {
      font-size: 11px; padding: 3px 8px;
      background: var(--green-dim); color: var(--bg);
      border: none; border-radius: 4px;
      cursor: pointer; font-weight: 600;
    }
    .copy-btn:hover { background: var(--green); }
    .copy-btn.copied { background: var(--bg3); color: var(--green); border: 1px solid var(--green); }

    .patch-diff { padding: 10px 12px; font-family: 'Courier New', monospace; font-size: 12px; }
    .patch-removed { color: #FF6680; background: rgba(255,68,102,0.08); display: block; padding: 1px 4px; border-radius: 2px; }
    .patch-added { color: #66FF99; background: rgba(0,255,136,0.08); display: block; padding: 1px 4px; border-radius: 2px; }
    .patch-note { font-size: 11px; color: var(--text-dim); font-style: italic; margin-top: 6px; padding: 0 4px; }

    .ai-note {
      font-size: 11px; color: var(--text-dim);
      background: rgba(255,204,0,0.05);
      border: 1px solid rgba(255,204,0,0.2);
      border-radius: 6px;
      padding: 6px 10px;
      margin-top: 8px;
    }

    /* ‚îÄ‚îÄ Pipeline status ‚îÄ‚îÄ */
    .pipeline-status {
      display: flex; align-items: center; gap: 8px;
      padding: 8px 16px;
      background: var(--bg2);
      border-top: 1px solid var(--border);
      font-size: 11px;
      color: var(--text-dim);
      min-height: 30px;
      flex-shrink: 0;
    }
    .pipeline-status .spinner {
      width: 12px; height: 12px;
      border: 2px solid var(--border);
      border-top-color: var(--green);
      border-radius: 50%;
      animation: spin 0.7s linear infinite;
      display: none;
    }
    .pipeline-status.running .spinner { display: block; }
    .pipeline-status.running .status-text { color: var(--green); }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* ‚îÄ‚îÄ Input bar ‚îÄ‚îÄ */
    #input-bar {
      padding: 12px 16px;
      background: var(--bg2);
      border-top: 1px solid var(--border);
      flex-shrink: 0;
    }
    .input-row {
      display: flex; align-items: center; gap: 8px;
      background: var(--bg3);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 8px 12px;
      transition: border-color 0.2s;
    }
    .input-row:focus-within { border-color: var(--green); }
    #prompt-input {
      flex: 1;
      background: transparent;
      border: none;
      outline: none;
      color: var(--text);
      font-size: 13px;
      resize: none;
      max-height: 100px;
      line-height: 1.5;
      font-family: inherit;
    }
    #prompt-input::placeholder { color: var(--text-dim); }
    #send-btn {
      background: var(--green);
      color: var(--bg);
      border: none;
      border-radius: 7px;
      width: 32px; height: 32px;
      cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      font-size: 15px;
      flex-shrink: 0;
      font-weight: bold;
      transition: background 0.15s;
    }
    #send-btn:hover { background: var(--green-dim); }
    #send-btn:disabled { background: var(--bg3); color: var(--text-dim); cursor: not-allowed; }

    .quick-prompts {
      display: flex; gap: 6px; flex-wrap: wrap;
      margin-bottom: 8px;
    }
    .quick-btn {
      font-size: 11px; padding: 4px 10px;
      background: var(--bg3); color: var(--text-dim);
      border: 1px solid var(--border); border-radius: 5px;
      cursor: pointer; transition: all 0.15s;
    }
    .quick-btn:hover { border-color: var(--green); color: var(--green); }

    /* ‚îÄ‚îÄ Settings panel ‚îÄ‚îÄ */
    #settings-panel {
      display: none;
      position: fixed; inset: 0;
      background: rgba(0,0,0,0.7);
      z-index: 100;
      align-items: center;
      justify-content: center;
    }
    #settings-panel.open { display: flex; }
    .settings-box {
      background: var(--bg2);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 24px;
      width: 480px;
      max-width: 95vw;
    }
    .settings-box h2 { color: var(--green); font-size: 16px; margin-bottom: 18px; }
    .settings-field { margin-bottom: 16px; }
    .settings-field label { display: block; font-size: 12px; color: var(--text-dim); margin-bottom: 6px; font-weight: 600; }
    .settings-field input, .settings-field select {
      width: 100%; padding: 8px 12px;
      background: var(--bg3); border: 1px solid var(--border);
      border-radius: 7px; color: var(--text); font-size: 13px;
      outline: none;
    }
    .settings-field input:focus, .settings-field select:focus { border-color: var(--green); }
    .settings-actions { display: flex; justify-content: flex-end; gap: 8px; margin-top: 20px; }
    .btn-primary { background: var(--green); color: var(--bg); border: none; border-radius: 7px; padding: 8px 20px; font-weight: 700; cursor: pointer; font-size: 13px; }
    .btn-secondary { background: transparent; color: var(--text-dim); border: 1px solid var(--border); border-radius: 7px; padding: 8px 16px; cursor: pointer; font-size: 13px; }
    .btn-secondary:hover { border-color: var(--green); color: var(--text); }

    /* ‚îÄ‚îÄ Empty state ‚îÄ‚îÄ */
    .empty-state {
      display: flex; flex-direction: column;
      align-items: center; justify-content: center;
      height: 100%; gap: 12px;
      color: var(--text-dim);
    }
    .empty-state .big-icon { font-size: 48px; }
    .empty-state h2 { font-size: 16px; color: var(--text); }
    .empty-state p { font-size: 12px; text-align: center; max-width: 280px; line-height: 1.6; }

    .files-list { margin-top: 8px; }
    .file-tag {
      display: inline-block; font-size: 11px;
      background: rgba(0,255,136,0.08); color: var(--green);
      border: 1px solid rgba(0,255,136,0.2); border-radius: 4px;
      padding: 2px 7px; margin: 2px;
    }
    .file-tag.vcd { color: #88AAFF; border-color: rgba(136,170,255,0.3); background: rgba(136,170,255,0.05); }
    .file-tag.log { color: var(--yellow); border-color: rgba(255,204,0,0.3); background: rgba(255,204,0,0.05); }
  </style>
</head>
<body>

<!-- Header -->
<div id="header">
  <div class="logo">
    <div class="logo-icon">F</div>
    <div>
      <h1>FABB</h1>
      <div class="subtitle">Full-Auto Bug Buster</div>
    </div>
  </div>
  <div class="header-right">
    <div id="folder-indicator" onclick="openSettings()">
      <div class="dot"></div>
      <span class="folder-text" id="folder-text">No folder set</span>
    </div>
    <button class="icon-btn" onclick="refreshIndex()" title="Refresh file index">‚Üª</button>
    <button class="icon-btn" onclick="openSettings()" title="Settings">‚öô</button>
  </div>
</div>

<!-- Main -->
<div id="main">
  <div id="chat-area">
    <div id="messages">
      <div class="empty-state" id="empty-state">
        <div class="big-icon">üêõ</div>
        <h2>Ready to bust bugs</h2>
        <p>Set your project folder in Settings, then ask me to debug your RTL files.</p>
        <p style="margin-top:4px">Try: <em style="color:var(--green)">"debug counter.v"</em> or <em style="color:var(--green)">"check latest simulation"</em></p>
      </div>
    </div>

    <!-- Pipeline status bar -->
    <div class="pipeline-status" id="pipeline-status">
      <div class="spinner"></div>
      <span class="status-text" id="status-text">Idle</span>
    </div>

    <!-- Input -->
    <div id="input-bar">
      <div class="quick-prompts" id="quick-prompts">
        <button class="quick-btn" onclick="quickPrompt('debug latest verilog file')">üîç Debug latest</button>
        <button class="quick-btn" onclick="quickPrompt('check latest simulation logs')">üìã Check logs</button>
        <button class="quick-btn" onclick="quickPrompt('find all reset logic bugs')">‚ö° Reset bugs</button>
        <button class="quick-btn" onclick="quickPrompt('what files are indexed?')">üìÅ List files</button>
      </div>
      <div class="input-row">
        <textarea id="prompt-input" rows="1" placeholder='Ask FABB to debug your RTL... e.g. "debug alu.v"'
          onkeydown="handleKey(event)" oninput="autoResize(this)"></textarea>
        <button id="send-btn" onclick="sendPrompt()">‚Üë</button>
      </div>
    </div>
  </div>
</div>

<!-- Settings Panel -->
<div id="settings-panel">
  <div class="settings-box">
    <h2>‚öô Settings</h2>
    <div class="settings-field">
      <label>Project Folder Path</label>
      <input type="text" id="cfg-folder" placeholder="/Users/you/my_rtl_project" />
    </div>
    <div class="settings-field">
      <label>LLM Provider</label>
      <select id="cfg-provider">
        <option value="openai">OpenAI (GPT-4o)</option>
        <option value="anthropic">Anthropic (Claude)</option>
      </select>
    </div>
    <div class="settings-field">
      <label>API Key <span style="color:var(--text-dim);font-weight:400">(optional ‚Äî enables AI explanations)</span></label>
      <input type="password" id="cfg-apikey" placeholder="sk-... or sk-ant-..." />
    </div>
    <div class="settings-actions">
      <button class="btn-secondary" onclick="closeSettings()">Cancel</button>
      <button class="btn-primary" onclick="saveSettings()">Save &amp; Index</button>
    </div>
  </div>
</div>

<script>
const API = 'http://127.0.0.1:8765';
let isRunning = false;

// ‚îÄ‚îÄ Conversation history (sent to LLM on every turn) ‚îÄ‚îÄ
let conversationHistory = [];

// ‚îÄ‚îÄ Init ‚îÄ‚îÄ
async function init() {
  try {
    const cfg = await fetchJSON('/api/config');
    updateFolderUI(cfg.folder);
    applyConfigToForm(cfg);
    if (cfg.folder) await refreshIndex(true);
  } catch(e) {
    setStatus('Backend not connected ‚Äî start server.py', false);
  }
}

async function fetchJSON(path, opts={}) {
  const r = await fetch(API + path, opts);
  return r.json();
}

// ‚îÄ‚îÄ Settings ‚îÄ‚îÄ
function openSettings() { document.getElementById('settings-panel').classList.add('open'); }
function closeSettings() { document.getElementById('settings-panel').classList.remove('open'); }

async function saveSettings() {
  const folder   = document.getElementById('cfg-folder').value.trim();
  const apiKey   = document.getElementById('cfg-apikey').value.trim();
  const provider = document.getElementById('cfg-provider').value;
  await fetchJSON('/api/config', {
    method: 'POST', headers: {'Content-Type':'application/json'},
    body: JSON.stringify({folder, api_key: apiKey, api_provider: provider})
  });
  updateFolderUI(folder);
  closeSettings();
  if (folder) {
    await refreshIndex();
    addFabbMessage(`üìÅ Project folder set to <strong>${escHtml(folder)}</strong>. Files indexed!`);
  }
}

function applyConfigToForm(cfg) {
  if (cfg.folder)       document.getElementById('cfg-folder').value   = cfg.folder;
  if (cfg.api_provider) document.getElementById('cfg-provider').value = cfg.api_provider;
}

function updateFolderUI(folder) {
  const ind = document.getElementById('folder-indicator');
  const txt = document.getElementById('folder-text');
  if (folder) {
    const parts = folder.replace(/\\/g,'/').split('/');
    txt.textContent = parts[parts.length-1] || folder;
    ind.classList.add('active');
    ind.title = folder;
  } else {
    txt.textContent = 'No folder set';
    ind.classList.remove('active');
  }
}

// ‚îÄ‚îÄ File index ‚îÄ‚îÄ
async function refreshIndex(silent=false) {
  try {
    setStatus('Indexing files...', true);
    const data = await fetchJSON('/api/refresh', {method:'POST', headers:{'Content-Type':'application/json'}, body:'{}'});
    if (data.error) { setStatus(data.error, false); if (!silent) addFabbMessage(`‚ö†Ô∏è ${escHtml(data.error)}`); return; }
    setStatus(`${data.count} file(s) indexed`, false);
    if (!silent) showIndexedFiles(data.files || []);
  } catch(e) { setStatus('Refresh failed', false); }
}

function showIndexedFiles(files) {
  const html = files.map(f => {
    const ext = f.split('.').pop();
    const cls = ext==='vcd' ? 'vcd' : (ext==='log'||ext==='txt') ? 'log' : '';
    return `<span class="file-tag ${cls}">${escHtml(f)}</span>`;
  }).join('');
  addFabbMessage(`üìÅ Index refreshed ‚Äî ${files.length} file(s) found:<div class="files-list">${html || '<em style="color:var(--text-dim)">No RTL files found</em>'}</div>`);
}

// ‚îÄ‚îÄ Messaging ‚îÄ‚îÄ
function removeEmptyState() {
  const el = document.getElementById('empty-state');
  if (el) el.remove();
}

function addUserMessage(text) {
  removeEmptyState();
  const msgs = document.getElementById('messages');
  const div = document.createElement('div');
  div.className = 'msg user';
  div.innerHTML = `<div class="msg-avatar">U</div><div class="msg-content"><div class="msg-bubble">${escHtml(text)}</div></div>`;
  msgs.appendChild(div);
  msgs.scrollTop = msgs.scrollHeight;
}

function addFabbMessage(html) {
  removeEmptyState();
  const msgs = document.getElementById('messages');
  const div = document.createElement('div');
  div.className = 'msg fabb';
  div.innerHTML = `<div class="msg-avatar">üêõ</div><div class="msg-content"><div class="msg-bubble">${html}</div></div>`;
  msgs.appendChild(div);
  msgs.scrollTop = msgs.scrollHeight;
  return div;
}

// Render plain text with basic markdown: **bold**, `code`, newlines
function renderMarkdown(text) {
  return escHtml(text)
    .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
    .replace(/`([^`]+)`/g, '<code style="background:var(--code-bg);padding:1px 5px;border-radius:3px;font-family:monospace;font-size:12px">$1</code>')
    .replace(/```([\s\S]*?)```/g, '<pre style="background:var(--code-bg);padding:10px;border-radius:6px;overflow-x:auto;font-size:12px;margin:6px 0">$1</pre>')
    .replace(/&lt;br&gt;/g, '<br>');
}

function addBugReport(report) {
  removeEmptyState();
  const msgs = document.getElementById('messages');
  const wrapper = document.createElement('div');
  wrapper.className = 'msg fabb';

  const sev   = report.severity || 'medium';
  const sevCls = `severity-${sev}`;
  const cycleInfo = report.cycle  ? ` ¬∑ Cycle ${escHtml(String(report.cycle))}` : '';
  const lineInfo  = report.line   ? ` ¬∑ Line ${escHtml(String(report.line))}`   : '';
  const sigInfo   = report.signal ? ` ¬∑ <code>${escHtml(report.signal)}</code>` : '';

  let bodyHtml = `<p class="bug-desc">${escHtml(report.description)}</p>`;

  if (report.llm_explanation && report.llm_explanation !== report.description) {
    bodyHtml += `<div class="llm-explanation"><div class="label">ü§ñ AI Analysis</div>${renderMarkdown(report.llm_explanation)}</div>`;
  }
  if (report.root_cause && report.root_cause !== 'N/A' && report.root_cause !== report.description) {
    bodyHtml += `<div class="llm-explanation" style="border-color:#FFCC00;margin-top:8px"><div class="label" style="color:#FFCC00">üîç Root Cause</div>${renderMarkdown(report.root_cause)}</div>`;
  }
  if (report.patch && (report.patch.original || report.patch.fixed)) {
    bodyHtml += `
      <div class="patch-block">
        <div class="patch-header"><span>Suggested Patch</span><button class="copy-btn" data-fix="${escHtml(report.patch.fixed||'')}">Copy Fix</button></div>
        <div class="patch-diff">
          ${report.patch.original ? `<span class="patch-removed">- ${escHtml(report.patch.original)}</span>` : ''}
          ${report.patch.fixed    ? `<span class="patch-added">+ ${escHtml(report.patch.fixed)}</span>` : ''}
          ${report.patch.explanation ? `<div class="patch-note">${escHtml(report.patch.explanation)}</div>` : ''}
        </div>
      </div>`;
  }
  if (report.note) bodyHtml += `<div class="ai-note">üí° ${escHtml(report.note)}</div>`;

  const card = document.createElement('div');
  card.className = `bug-card ${sevCls}`;

  const header = document.createElement('div');
  header.className = 'bug-card-header';
  header.innerHTML = `
    <span class="severity-badge ${sevCls}">${sev}</span>
    <span class="bug-label">${escHtml(report.label)}</span>
    <span class="bug-meta">${sigInfo}${cycleInfo}${lineInfo}</span>
    <span class="chevron">‚ñ∂</span>`;

  const body = document.createElement('div');
  body.className = 'bug-card-body';
  body.innerHTML = bodyHtml;

  card.appendChild(header);
  card.appendChild(body);
  header.addEventListener('click', () => card.classList.toggle('open'));
  card.classList.add('open'); // auto-open

  const copyBtn = body.querySelector('.copy-btn');
  if (copyBtn) {
    copyBtn.addEventListener('click', e => {
      e.stopPropagation();
      navigator.clipboard.writeText(copyBtn.getAttribute('data-fix') || '').then(() => {
        copyBtn.textContent = 'Copied!'; copyBtn.classList.add('copied');
        setTimeout(() => { copyBtn.textContent = 'Copy Fix'; copyBtn.classList.remove('copied'); }, 2000);
      });
    });
  }

  const avatar = document.createElement('div');
  avatar.className = 'msg-avatar';
  avatar.textContent = 'üêõ';

  const content = document.createElement('div');
  content.className = 'msg-content';
  content.style.maxWidth = '100%';
  content.appendChild(card);

  wrapper.appendChild(avatar);
  wrapper.appendChild(content);
  msgs.appendChild(wrapper);
  msgs.scrollTop = msgs.scrollHeight;
}

// ‚îÄ‚îÄ Sending ‚îÄ‚îÄ
async function sendPrompt() {
  if (isRunning) return;
  const input = document.getElementById('prompt-input');
  const prompt = input.value.trim();
  if (!prompt) return;

  input.value = '';
  input.style.height = '';
  addUserMessage(prompt);

  isRunning = true;
  document.getElementById('send-btn').disabled = true;
  setStatus('Thinking...', true);

  // Typing indicator
  const typing = addFabbMessage('<span style="color:var(--text-dim)">Thinking<span id="dots">.</span></span>');
  const dotsInterval = setInterval(() => {
    const d = document.getElementById('dots');
    if (d) d.textContent = d.textContent.length >= 3 ? '.' : d.textContent + '.';
  }, 400);

  try {
    const data = await fetchJSON('/api/chat', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ prompt, history: conversationHistory })
    });

    clearInterval(dotsInterval);
    typing.remove();

    // Show file load messages (small status line, not a full bubble)
    if (data.messages && data.messages.length) {
      const pipeHtml = data.messages.map(m =>
        `<div class="pipeline-line">${escHtml(m)}</div>`
      ).join('');
      addFabbMessage(pipeHtml);
    }

    // Show plain text response (the LLM\'s actual reply)
    if (data.plain_text && data.plain_text.trim()) {
      addFabbMessage(renderMarkdown(data.plain_text));
    }

    // Show structured bug cards
    if (data.bug_reports && data.bug_reports.length) {
      for (const report of data.bug_reports) {
        addBugReport(report);
      }
    }

    // Add to conversation history so follow-ups have context
    conversationHistory.push({ role: 'user',      content: prompt });
    conversationHistory.push({ role: 'assistant', content: data.plain_text || '' });

    // Keep history from growing too large (last 20 turns)
    if (conversationHistory.length > 40) conversationHistory = conversationHistory.slice(-40);

    setStatus('Ready', false);
  } catch(e) {
    clearInterval(dotsInterval);
    typing.remove();
    addFabbMessage('‚ùå Could not reach backend. Make sure server.py is running.');
    setStatus('Error', false);
  }

  isRunning = false;
  document.getElementById('send-btn').disabled = false;
}

function quickPrompt(text) {
  document.getElementById('prompt-input').value = text;
  sendPrompt();
}

function handleKey(e) {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendPrompt(); }
}

function autoResize(el) {
  el.style.height = 'auto';
  el.style.height = Math.min(el.scrollHeight, 100) + 'px';
}

function setStatus(text, running) {
  document.getElementById('status-text').textContent = text;
  document.getElementById('pipeline-status').classList.toggle('running', running);
}

function escHtml(s) {
  if (!s) return '';
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/\n/g,'<br>');
}

init();
</script>
</body>
</html>